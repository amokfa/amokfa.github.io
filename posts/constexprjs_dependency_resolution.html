<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><link rel="icon" href="/favicon.ico" sizes="32x32" type="image/x-icon"><meta name="viewport" content="width=device-width, min-width=600, initial-scale=1, minimum-scale=1"><link rel="stylesheet" href="/static/css/styles.css"><link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&amp;family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&amp;display=swap" rel="stylesheet"><meta name="description" content="This page describes how constexprjs figures how the dependencies of a page"><meta name="keywords" content="constexprjs"><title>Dependency resolution in ConstexprJS</title><link rel="stylesheet" href="/static/css/prism.css"><noscript>
  <style>
    #left-sidebar .open, #left-sidebar .close, #right-sidebar .open, #right-sidebar .close, #right-sidebar #toggle_theme_wrapper {
      display: none;
    } 
  </style>
  </noscript></head><body class="light"><script src="/static/js/dynamic-pre.js"></script>







<img alt="background" class="bg" id="main_bg" src="/static/img/bg.jpg" loading="lazy"><div id="view_bg_btn" onclick="show_image_tag(document.querySelector('#main_bg'))"><div id="screen_img"></div></div>


<div id="left-sidebar">
    <div class="dialog">
        <div class="heading">Table of content</div>
        <ol class="content"><li><a href="#top">Top</a></li><li><a href="#summary">Summary</a></li></ol>
    </div>
    <img alt="open left sidebar" src="/static/img/icons/swipe.svg" class="open">
    <img alt="close left sidebar" src="/static/img/icons/swipe.svg" class="close">
</div><div id="right-sidebar">
    <div class="dialog">
        <div class="heading">Settings</div>
        <div class="content">
            <button>Subscribe</button>
            <div id="toggle_theme_wrapper"><div id="toggle_theme"></div>
        </div>
    </div>
    <img alt="open right sidebar" src="/static/img/icons/swipe.svg" class="open">
    <img alt="close right sidebar" src="/static/img/icons/swipe.svg" class="close">
</div></div><div id="body_wrapper" class="first_body_wrapper"><header><nav><a href="/">
              HOME
          </a><a href="/projects.html">
              PROJECTS
          </a><a href="/tags.html">
              TAGS
          </a><a href="/about.html">
              ABOUT
          </a></nav><h1 id="main_title">Dependency resolution in ConstexprJS</h1><ul class="tags_list"><li><a class="tag_element" href="/tags/constexprjs.html">constexprjs</a></li></ul></header><article role="main">
    
    
    
    
    

    

    

    
    
    

    
    

    
<section id="top"><h2 style="display: none;">Top</h2><p>
        The dependency resolution system of constexprjs is semi-automatic. The compiler figures out the dependencies
        (css, images, javascript, static files) of a page on its own, but the constexpr code inside a page can override
        the default behavior if it needs to. This article describes how the dependency resolution process works.
    </p><p>
        The compiler monitors the HTTP requests made by the pages when they're being rendered. All the local static
        resources requested by the page are added to the dependency list of that page, with the exception of script
        files which are marked as <progi role="figure">constexpr</progi>.
    </p><prog class=" language-html" role="figure"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/cat.jpg<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/ui.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">constexpr</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/packages/jquery.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">constexpr</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/js/render.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></prog><p>
        The above snippet will cause <progi role="figure">ui.js</progi> and <progi role="figure">cat.jpg</progi> to be added to the dependency list of the page.
        <progi role="figure">jquery.js</progi> and <progi role="figure">render.js</progi> will not be added to the dependency list.
    </p><p>
        Consider what would've happened if the rendering code in the page fetched <progi role="figure">jquery.js</progi> or some json files using XHR.
        The compiler will think that these files being fetched are regular resources and will add them to the dependency list as well. You can use the
        <progi role="figure">window._ConstexprJS_.addExclusion</progi> hook from constexpr code to deal with this issue. Exclusions added using this
        method take precedence over the automatic dependency resolution:
    </p><prog class=" language-js" role="figure"><span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/jquery.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token arrow operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">_ConstexprJS_</span><span class="token punctuation">.</span><span class="token method function property-access">addExclusion</span><span class="token punctuation">(</span><span class="token string">'/jquery.js'</span><span class="token punctuation">)</span></prog><p>
        Let's consider another scenario. What if some runtime code depended on <progi role="figure">jquery.js</progi> as well. The
        file won't be copied because it's excluded using the <progi role="figure">addExclusion</progi> hook. To deal with this issue,
        the compiler injects another hook called <progi role="figure">window._ConstexprJS_.addDependency</progi> that takes precedence
        over <progi role="figure">addExclusion</progi>. You can call it from the dynamic code and if a resource is specified as a
        dependency by the page using this hook, it will be included no matter what.
    </p></section><section id="summary"><h2>Summary</h2><p>
        Mechanisms lower in the list take precedence over the ones that appear before them:
    </p><ol>
        <li>HTTP requests made by the page. (included) (automatic)</li>
        <li>Scripts included with <progi role="figure">constexpr</progi> attribute. (excluded) (automatic)</li>
        <li><progi role="figure">addExclusion</progi> hook. (excluded) (manual)</li>
        <li><progi role="figure">addDependency</progi> hook. (included) (manual)</li>
    </ol><h3>Note</h3><p>
        Dependencies aren't copied over if <progi role="figure">--skip-resources</progi> option is specified. The dependency
        resolution process works independent of this option and the dependency information will be exported if
        <progi role="figure">--deps</progi> option is specified.
    </p><blockquote>
        See pages tagged with <a class="tag_element" href="/tags/constexprjs.html">constexprjs</a> for more guides.
    </blockquote></section></article><footer>
    <div class="links">
        <div class="social">
            <div class="footer-title">Share this page:</div>
            <a rel="noopener" title="twitter" class="svg-icon twitter" target="_blank" href="https://twitter.com/share?text=Dependency resolution in ConstexprJS&amp;url=https://amokfa.github.io/posts/constexprjs_dependency_resolution.html"></a>
            <a rel="noopener" title="facebook" class="svg-icon facebook" target="_blank" href="https://www.facebook.com/sharer.php?u=https://amokfa.github.io/posts/constexprjs_dependency_resolution.html"></a>
            <a rel="noopener" title="reddit" class="svg-icon reddit" target="_blank" href="https://www.reddit.com/submit?title=Dependency resolution in ConstexprJS&amp;url=https://amokfa.github.io/posts/constexprjs_dependency_resolution.html"></a>
            <a rel="noopener" title="hacker news" class="svg-icon hn" target="_blank" href="https://news.ycombinator.com/submitlink?t=Dependency resolution in ConstexprJS&amp;u=https://amokfa.github.io/posts/constexprjs_dependency_resolution.html"></a>
        </div>
    </div>

</footer></div><script src="/static/js/dynamic-post.js" defer=""></script><script src="/static/js/mtm.js" defer=""></script></body></html>